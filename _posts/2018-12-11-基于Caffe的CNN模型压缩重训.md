---
layout: post
title: 基于Caffe的CNN模型压缩重训
date: 2018-12-11
author: 钟凯
tags: 深度学习
---

# 基于Caffe的CNN模型压缩重训

# 部署压缩Caffe

## 安装依赖库

这一过程与安装普通caffe并无太多不同，压缩工具版caffe只是在caffe的基础上增加了一些功能，安装流程和caffe一样，都是通过编译进行安装。

## 调整make config与makefile

这次需要调整的地方主要是opencv和python，因为opencv我自己装了3.0版本以上，pycaffe用起来也比较方便，所以都进行了配置，最值得注意的一点是，压缩版caffe比普通caffe多用了一些opencv的库，最要命的是这个：

![erorr](/post_img/2018-12-11/1.png)

即，VideoCapture系列库，这个库在opencv 3.0以上版本中，多了一个需要链接的动态连接库，而3.0版本以下，是包含在另一个caffe的makefile已经连接的库中。
由于一直对着make config和源码debug，导致很久没有正确找到no reference的bug来源，开始还以为是opencv改版后改编了函数，而压缩工具是基于opencv2.4开发的，必须降级。幸好心有不甘查了半天官方的文档，并且对比了2.4的文档。发现两个版本都有这个函数，那为啥不对呢，后来灵机一动，不再找caffe相关的bug，而是直接找opencv的bug，终于发现，是makefile中应该多加一个动态连接库：参考https://stackoverflow.com/questions/46045197/undefined-reference-to-cvvideocapturevideocaptureint 、 https://stackoverflow.com/questions/45867917/undefined-reference-to-cvvideocapturevideocaptureint

![fix](/post_img/2018-12-11/2.png)

经过这个调整，就能够成功编译了。不过值得注意的是，make all和make test都能过，但是make runtest会有错误，经过余老板点拨，我感觉可能是开发时候改了源码，但没有改测试部分的源码，导致的测试不过，不过既然是发行版工具，应该没有太大的bug。就放心用了。

## 其他debug方法
上述问题困然很久，还尝试了升级或者降级gcc编译器的方法，具体过程如下：

![debug](/post_img/2018-12-11/3.png)

# finetune VGG-Face

# compress VGG-Face