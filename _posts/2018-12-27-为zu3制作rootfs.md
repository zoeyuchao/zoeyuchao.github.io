---
layout: post
title: 为zu3制作rootfs
date: 2018-12-29
author: 阿金
tags: 技术 调试笔记
---

# 为zu3制作rootfs

## 下载目标文件的镜像文件

比如在 tuna 上下载 ARM ubuntu server。

```Shell
wget https://mirrors.tuna.tsinghua.edu.cn/ubuntu-cdimage/ubuntu/releases/16.04/release/ubuntu-16.04.4-server-arm64.iso
```

## 挂在rootfs

用mount命令挂在，比方说是 /dev/sdc2

```Shell
sudo mount /dev/sdc2 ./sdc2/
```

## 将镜像文件同步到rootfs中

### 挂载 iso 文件

```Shell
sudo mount -o loop  ubuntu-16.04.4-server-arm64.iso ./tmpiso
```

rootfs在 tmpiso/install/filesystem.squashfs 中

可以通过 ```ls tmpiso/install/``` 查看。


### 生成rootfs

```Shell
sudo unsquashfs -d rootfs/ tmpiso/install/filesystem.squashfs
```

如此，在当前目录下生成了 rootfs 文件夹。即是可以同步到sd卡分区的文件系统。

### 取消root密码

在 rootfs/etc/passwd 中修改第一行，把 root 和 0 之间的 x 删除。

```Shell
# in the first line
root:x:0:0:root:/root:/bin/bash
# we need to remove 'x'
root::0:0:root:/root:/bin/bash
```

### 同步文件系统

```Shell
rm -rf sdc2/ #清空挂在后的文件系统
sudo rsync -av  ./rootfs ../sdc2/ #将解压过后的文件提供同步到sd卡上
sync #等待数据被确实写入SD卡
```

### 启动
至此，就可以启动啦。

## 可能遇到的问题

### 串口无法登陆

在zu3上用串口启动的时候发现报错，还没到输密码就错了

```Shell
Debian GNU/Linux 9 xlnx ttyPS0
localhost login: root Login incorrect
```
原因是在rootfs中没有允许*ttyPS0*使用root登录。

需要在sd卡的文件系统中。```/etc/securetty``` 文件里添加ttyPS0。

随便找个地方添加：

添加之前

```
# pmac_zilog - port
ttyPZ0
ttyPZ1
ttyPZ2
ttyPZ3

```

添加之后


```
# pmac_zilog - port
ttyPZ0
ttyPZ1
ttyPZ2
ttyPZ3
ttyPS0
```

当然，串口的名称不一定就是 ttyPS0，可以在首次登录失败的时候查询到串口名称。
