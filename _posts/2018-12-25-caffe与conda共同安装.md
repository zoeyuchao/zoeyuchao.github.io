---
layout: post
title: caffe与conda共同安装
date: 2018-12-21
author: 阿金
tags: 技术 调试笔记
---

# caffe与conda共同安装

本环境均在 ubuntu16.04 下完成。conda的 python 为 3.7

## 基础操作

1. 新建 conda 的虚拟环境 compcaffe

    ```Shell
    conda create -n compcaffe python=3.7
    conda activate compcaffe
    ```

    然后在 caffe/python 文件夹中安装python的依赖。

    ```Shell
    for req in $(cat requirements.txt); do conda install $req; done
    ```

2. 然后修改 caffe 的 makefile
    修改过后（左<）和修改之前的

    ```text
    42c42
    < COMMON_FLAGS += -DCAFFE_VERSION=$(DYNAMIC_VERSION_MAJOR).$(DYNAMIC_VERSION_MINOR).$(DYNAMIC_VERSION_REVISION) -std=c++11
    ---
    > COMMON_FLAGS += -DCAFFE_VERSION=$(DYNAMIC_VERSION_MAJOR).$(DYNAMIC_VERSION_MINOR).$(DYNAMIC_VERSION_REVISION)
    181c181
    < LIBRARIES += glog gflags protobuf boost_system boost_filesystem m hdf5_serial_hl hdf5_serial
    ---
    > LIBRARIES += glog gflags protobuf boost_system boost_filesystem m
    204c204
    <               LIBRARIES += opencv_imgcodecs opencv_videoio
    ---
    >               LIBRARIES += opencv_imgcodecs
    ```
    主要操作为：
    1. 在 42 行: *COMMON_FLAGS* 里增加 *-std=c++11* 选项，因为我们caffe里面用到了C++11的特性，但是我们的编译器可能需要显示指定编译方式。

    2. 在 181 行: *LIBRARIES* 里增加 *hdf5_serial_hl hdf5_serial* 两个库，因为ubuntu16之后 hdf5 安装位置发生了变化。

    3. 在 204 行: *LIBRARIES* 里增加 *opencv_videoio* 这个库，原因是采用opencv3 编译，其中处理视频的操作需要这个库。

3. 修改 caffe 的 makefile.config
    修改过后（左<）和修改之前的
    ```text
    23c23
    < OPENCV_VERSION := 3
    ---
    > # OPENCV_VERSION := 3
    39c39,42
    < CUDA_ARCH :=  \
    ---
    > CUDA_ARCH := -gencode arch=compute_20,code=sm_20 \
    >               -gencode arch=compute_20,code=sm_21 \
    >               -gencode arch=compute_30,code=sm_30 \
    >               -gencode arch=compute_35,code=sm_35 \
    50c53
    < BLAS := open
    ---
    > BLAS := atlas
    68c71
    < # PYTHON_INCLUDE := /usr/include/python2.7 \
    ---
    > PYTHON_INCLUDE := /usr/include/python2.7 \
    72,75c75,78
    < ANACONDA_HOME := $(HOME)/anaconda3/envs/compcaffe
    < PYTHON_INCLUDE := $(ANACONDA_HOME)/include \
    <               $(ANACONDA_HOME)/include/python3.7m \
    <               $(ANACONDA_HOME)/lib/python3.7m/site-packages/numpy/core/include
    ---
    > # ANACONDA_HOME := $(HOME)/anaconda
    > # PYTHON_INCLUDE := $(ANACONDA_HOME)/include \
    >               # $(ANACONDA_HOME)/include/python2.7 \
    >               # $(ANACONDA_HOME)/lib/python2.7/site-packages/numpy/core/include
    78c81
    < PYTHON_LIBRARIES := boost_python37 python3.7m
    ---
    > # PYTHON_LIBRARIES := boost_python3 python3.5m
    83,84c86,87
    < # PYTHON_LIB := /usr/lib
    < PYTHON_LIB := $(ANACONDA_HOME)/lib
    ---
    > PYTHON_LIB := /usr/lib
    > # PYTHON_LIB := $(ANACONDA_HOME)/lib
    91c94
    < WITH_PYTHON_LAYER := 1
    ---
    > # WITH_PYTHON_LAYER := 1
    94,95c97,98
    < INCLUDE_DIRS := $(PYTHON_INCLUDE) /usr/local/include /usr/include/hdf5/serial/
    < LIBRARY_DIRS := $(PYTHON_LIB) /usr/local/lib /usr/lib /usr/lib/x86_64-linux-gnu/hdf5/serial
    ---
    > INCLUDE_DIRS := $(PYTHON_INCLUDE) /usr/local/include
    > LIBRARY_DIRS := $(PYTHON_LIB) /usr/local/lib /usr/lib
    112c115
    < LINKFLAGS := -Wl,-rpath,$(ANACONDA_HOME)/anaconda3/lib
    ---
    >
    ```

    主要修改如下：

    1. 23行： 指定用opencv3编译

    2. 39行： 取消对老版本GPU的支持

    3. 50行： 采用 openblas 库

    4. 68行: 取消采用python2

    5. 72-75行：指定 anaconda3 中虚拟环境的路径。并且指定python的版本，注意3.7版本的python库名称为 python3.7m

    6. 78 行：指定python_boost的版本，这里是 boost_python37。这个库对应虚拟环境的路径中 $(ANACONDA_HOME)/lib/，在该文件夹下可以找到 libboost_python37.so，把文件名前面的 lib 后面的 .so 去掉，剩下 boost_python37 就是我们需要链接的库。当然里面也有 libpython3.7m.so 对应的名称是python3.7

    7. 83，84 行：指定python库的路径为anaconda的路径。

    8. 91行：允许编译pythonlayer

    9. 94，95行：增加 /usr/include/hdf5/serial/ 作为include路径。增加/usr/lib/x86_64-linux-gnu/hdf5/serial 作为LIBRARY路径。原因就是新的 ubuntu 安装 hdf5 路径出了偏差。

    10. 112 行增加 ```LINKFLAGS := -Wl,-rpath,$(HOME)/anaconda3/lib```
        如果不加，会在python中```import caffe```是出现如下错误：
        ```text
        Traceback (most recent call last):
        File "<stdin>", line 1, in <module>
        File "/home/gaof/caffe-master/python/caffe/__init__.py", line 1, in <module>
            from .pycaffe import Net, SGDSolver, NesterovSolver, AdaGradSolver, RMSPropSolver, AdaDeltaSolver, AdamSolver, NCCL, Timer
        File "/home/gaof/caffe-master/python/caffe/pycaffe.py", line 13, in <module>
            from ._caffe import Net, SGDSolver, NesterovSolver, AdaGradSolver, \
        ModuleNotFoundError: No module named 'caffe._caffe'
        ```

## 关于protobuf

```text
PROTOC src/caffe/proto/caffe.proto
CXX .build_release/src/caffe/proto/caffe.pb.cc
In file included from .build_release/src/caffe/proto/caffe.pb.cc:4:0:
.build_release/src/caffe/proto/caffe.pb.h:12:2: error: #error This file was generated by a newer version of protoc which is  
 #error This file was generated by a newer version of protoc which is
  ^
```

这个问题就是 *libprotobuf* 库和 *protoc* 不匹配造成的。
通过```protoc --version```来寻找自己的protoc程序是否和 libprotobuf 匹配。应该都是在 conda 的虚拟环境文件夹下。
